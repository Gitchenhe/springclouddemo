# This is a basic workflow to help you get started with Actions

name: SpringCloudDemo-CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches:
    - master
    - develop

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:

    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2

    # 执行打包操作
    - name: 设置JDK为1.8版本
      uses: actions/setup-java@v1
      with:
        java-version: 1.8

    - name: 开始打包
      run: mvn -B package --file pom.xml

    - name: 构建并上传上传eureka镜像
      env:
        aliyun_username: ${{ secrets.aliyun_username }}
        aliyun_password: ${{ secrets.aliyun_password }}
        image_name: eureka
        image_tag: latest
      run:
        echo 准备执行Dockerfile
        sudo docker login --username=${aliyun_username} registry.cn-beijing.aliyuncs.com --password=${{ secrets.aliyun_password }}
        sudo docker build -t ${image_name}:${image_tag} ./server/eureka-server/
        sudo docker tag ${image_name}:${image_tag} registry.cn-hangzhou.aliyuncs.com/ch-docker/docker:${image_tag}
        sudo docker push registry.cn-hangzhou.aliyuncs.com/ch-docker/docker:${image_tag}
        echo 上传完毕